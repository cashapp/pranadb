syntax = "proto3";

package squareup.cash.pranadb.service.v1;

option go_package = "github.com/squareup/pranadb/protos/squareup/cash/pranadb/v1/service";

message Result {
}

enum ColumnType {
  COLUMN_TYPE_UNSPECIFIED = 0;
  COLUMN_TYPE_TINY_INT = 1;
  COLUMN_TYPE_INT = 2;
  COLUMN_TYPE_BIG_INT = 3;
  COLUMN_TYPE_DOUBLE = 4;
  COLUMN_TYPE_DECIMAL = 5;
  COLUMN_TYPE_VARCHAR = 6;
  COLUMN_TYPE_TIMESTAMP = 7;
}

message DecimalParams {
  uint32 decimal_precision = 3;
  uint32 decimal_scale = 4;
}

message Column {
  string name = 1;
  ColumnType type = 2;
  optional DecimalParams decimal_params = 3;
}

// Issue a query.
//
// The response is:
//
//     response ::= error | pages
//     pages ::= column (page* | error)
//
// Where page* terminates when more = false.
message ExecuteSQLStatementRequest {
  string query = 1;
  // Size of each page of results returned when paginating.
  int32 page_size = 2;
}

// Column definitions sent prior to a set of Pages.
message Columns {
  repeated Column columns = 1;
}

// Each query may return an arbitrary number of pages.
//
// Pagination should terminate once either an error is returned in
// ExecuteSQLStatementResponse or Page.more is false.
message Page {
  uint64 count = 1;
  bytes rows = 2; // Serialized rows.
  // True if there is more data to be retrieved.
  bool more = 3;
}

message ExecuteSQLStatementResponse {
  oneof result {
    string error = 1;
    Columns columns = 2;
    Page page = 3;
  }
}

service PranaDBService {
  // Bidirectional stream to emulate MySQL's persistent connection.
  rpc ExecuteSQLStatement(stream ExecuteSQLStatementRequest) returns (stream ExecuteSQLStatementResponse);
}
